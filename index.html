<html>
<head>
<style>
body {
	background-color: #F5F5F5;
	color: #83A1B6;
}
.title {
	font-family: sans-serif;
	font-size: 20pt;
}
.annotation-ready {
	background-color: #C7D0D5;
}
.annotation-over {
	background-color: #B7C0C5;
}
.annotation-selected {
	background-color: #FF9900;
}
</style>
<meta charset="utf-8" />
<title>Hexxer</title>
</head>
<body>
<script src="jquery.js"></script>
<script> 
function parseLine(line) {
	var l = new Object();
	var elems = line.split("  ");
	if (elems.length < 4) {
		return undefined;
	}
	l.address = elems[0];
	l.first = elems[1];
	l.second = elems[2];
	l.data = elems[3];
	if (elems.length > 4) {
		var i = 4;
		while (i != elems.length) {
			l.data += "  " + elems[i];
			i++;
		}
	}
	return l;
}

function lineContainsAnnotations(line_object) {
	var start_address = parseInt("0x" + line_object.address);
	var end_address = start_address + 15;

	var matches = [];

	for (var i = 0; i < annotations.length; i++) {
		var a_start = annotations[i].s;
		var a_end = annotations[i].e;
		if (a_start >= start_address && a_start <= end_address && a_end <= end_address) {
			// |----S--- ---E----|
			matches.push({idx: i, s: a_start - start_address, e: a_end - start_address});
		} else if (a_start >= start_address && a_start <= end_address) {
			// |----S--- --------|
			matches.push({idx: i, s: a_start - start_address, e: 15});
		} else if (a_start < start_address && a_end > end_address) {
			// S |-------- --------| E
			matches.push({idx: i, s: 0, e: 15});
		} else if (a_end >= start_address && a_end <= end_address) {
			// |-------- ---E----|
			matches.push({idx: i, s: 0, e: a_end - start_address});
		}
	}

	return matches;
}

function sanitise(data) {
	data = data.replace("<", "&lt;");
	data = data.replace(">", "&gt;");
	return data;
}

// TODO: automatically load annotations
var annotations = [
{s: 0x0, e: 0x7, d: "Magic Number, always 'DEX\\n035\\0'"},
{s: 0x8, e: 0xb, d: "Adler32 checksum of whole file apart from the first 12 bytes."},
{s: 0xc, e: 0x1f, d: "SHA-1 signature of the rest of the file. (Useless.)"},
{s: 0x20, e: 0x23, d: "File size (0x1b0 = 432 bytes)"},
{s: 0x24, e: 0x27, d: "Header size (will always be 0x70 = 112 bytes)"},
{s: 0x28, e: 0x2b, d: "Endianness tag"},
{s: 0x2c, e: 0x2f, d: "Link section size"},
{s: 0x30, e: 0x33, d: "Link section offset"},
{s: 0x34, e: 0x37, d: "Map section offset, starts at 0x128"},
{s: 0x38, e: 0x3b, d: "Number of StringIDs, 5"},
{s: 0x3c, e: 0x3f, d: "Offset to StringIDs table, 0x70"},
{s: 0x40, e: 0x43, d: "Number of TypeIDs, 3"},
{s: 0x44, e: 0x47, d: "Offset to TypeIDs table, 0x84"},
{s: 0x48, e: 0x4b, d: "Number of ProtoIDs, 1"},
{s: 0x4c, e: 0x4f, d: "Offset to ProtoIDs table, 0x90"},
{s: 0x50, e: 0x53, d: "Number of FieldIDs, 0"},
{s: 0x54, e: 0x57, d: "Offset to FieldIDs table, 0x0"},
{s: 0x58, e: 0x5b, d: "Number of MethodIDs, 2"},
{s: 0x5c, e: 0x5f, d: "Offset to MethodIDs table, 0x9c"},
{s: 0x60, e: 0x63, d: "Number of ClassDefs, 1"},
{s: 0x64, e: 0x67, d: "Offset to ClassDefs table, 0xac"},
{s: 0x68, e: 0x6b, d: "Data section size, bytes"},
{s: 0x6c, e: 0x6f, d: "Data section offset, starts at 0xcc"},
{s: 0x70, e: 0x73, d: "StringID 0, pointing to StringData at 0xe4 (\"<init>\")"},
{s: 0x74, e: 0x77, d: "StringID 1, pointing to StringData at 0xec (\"LSmall;\")"},


{s: 0xac, e: 0xaf, d: "((Start of the solitary ClassDef)) Index into the TypeID table for this class."},
{s: 0xb0, e: 0xb3, d: "Access flags for defined class."},
{s: 0xb4, e: 0xb7, d: "Index into the TypeID table for the super class of this class. (java.lang.Object)"},
{s: 0xbc, e: 0xbf, d: "Index into the StringID table for the name of the source file of this class."},
{s: 0xc4, e: 0xc7, d: "Offset to the ClassData item for this ClassDef, at 0x11d"},

{s: 0xe4, e: 0xe4, d: "string.length of this StringData, 6"},
{s: 0xe5, e: 0xea, d: "\"<init>\" StringData"},
{s: 0xeb, e: 0xeb, d: "null character that comes at the end of every String"},

{s: 0xec, e: 0xec, d: "string.length of this StringData, 7"},
{s: 0xed, e: 0xf3, d: "\"LSmall;\" StringData"},
{s: 0xf4, e: 0xf4, d: "null character that comes at the end of every String"},

{s: 0x11d, e: 0x11d, d: "((Start of the solitary ClassData)) Number of static fields this class has."},
{s: 0x11e, e: 0x11e, d: "Number of instance fields this class has."},
{s: 0x11f, e: 0x11f, d: "Number of direct methods this class has."},
{s: 0x120, e: 0x120, d: "Number of virtual methods this class has."},

];

var prev_mouseover_id = undefined;
var prev_selected_id = undefined;

$( document ).ready(function() {

	$.get("simple-dex.txt", function(data) {
		var lines = data.split("\n");

		var code_view = $(".code_view");

		$.each(lines, function(n, line) {
			var line_object = parseLine(line);

			if (line_object == undefined) {
				return;
			}

			var spacer_span = $( "<span style=\"margin-left:20px\"></span>" );

			var line_div = $( "<div id=\"L" + line_object.address + "\" class=\"line\"></div>" );

			var address_span = $( "<span class=\"address\">" + line_object.address + "</span>" );
			address_span.appendTo(line_div);
			spacer_span.appendTo(line_div);

			var matches = lineContainsAnnotations(line_object);

			if (matches.length > 0) {

				//console.log(line_object);
				//console.log(matches);

				var bytes = line_object.first.split(" ").concat(line_object.second.split(" "));

				var byte_string = "&nbsp;&nbsp;";
				for (var i = 0; i < 16; i++) {
					for (var j = 0; j < matches.length; j++) {
						if (matches[j].s == i) {
							byte_string += "<span class=\"annotation-ready\" id=\"AN" + matches[j].idx + "\">";
						}
					}
					byte_string += bytes[i];
					for (var j = 0; j < matches.length; j++) {
						if (matches[j].e == i) {
							byte_string += "</span>";
						}
					}
					if (i != 15) {
						byte_string += "&nbsp;";
						if (i == 7) {
							byte_string += "&nbsp;";
						}
					}
				}

				var bytes_span = $( "<span class=\"bytes\">" + byte_string + "</span>" );
				bytes_span.appendTo(line_div);
				spacer_span.appendTo(line_div);
			} else {
				var bytes_span = $( "<span class=\"bytes\">&nbsp;&nbsp;" + line_object.first + "&nbsp;&nbsp;" + line_object.second + "</span>" );
				bytes_span.appendTo(line_div);
				spacer_span.appendTo(line_div);
			}

			var data_span = $( "<span class=\"data\">" + sanitise(line_object.data) + "</span>" );
			data_span.appendTo(line_div);

			line_div.appendTo(code_view);
		});

		var clickers = $(".annotation-ready");
		for (var i = 0; i < clickers.length; i++) {
			var clicker = clickers[i];
			var id = parseInt(clicker.id.replace("AN", ""));
			var anno = annotations[id];
			if (anno.clickers == undefined) {
				anno.clickers = [clicker];
			} else {
				anno.clickers.push(clicker);
			}
			$(clicker).mouseenter(function(e) {
				var this_id = parseInt(e.toElement.id.replace("AN", ""));
				if (this_id != prev_selected_id) {
					for (var j = 0; j < annotations[this_id].clickers.length; j++) {
						annotations[this_id].clickers[j].className = "annotation-over";
					}
					prev_mouseover_id = this_id;
				}
			});
			$(clicker).mouseleave(function(e) {
				if (prev_mouseover_id != prev_selected_id) {
					for (var j = 0; j < annotations[prev_mouseover_id].clickers.length; j++) {
						annotations[prev_mouseover_id].clickers[j].className = "annotation-ready";
					}
				}
				prev_mouseover_id = undefined;
			});
			$(clicker).click(function(e) {
				var this_id = parseInt(e.toElement.id.replace("AN", ""));
				if (this_id == prev_selected_id) {
					return;
				}
				$(".annotation").text(annotations[this_id].d);
				for (var j = 0; j < annotations[this_id].clickers.length; j++) {
					annotations[this_id].clickers[j].className = "annotation-selected";
				}
				if (prev_selected_id != undefined) {
					for (var j = 0; j < annotations[prev_selected_id].clickers.length; j++) {
						annotations[prev_selected_id].clickers[j].className = "annotation-ready";
					}
				}
				prev_selected_id = this_id;
			});
		}
	});
});

</script>

<div class="title">Small.dex - A simple DEX file</div>
<br/>
<br/>
<div class="code_view" style="font-family:monospace; font-size:14pt; float:left"></div>
<div class="annotation" style="font-family:monospace; font-size:12pt; width:350px; float:right">Click on boxes for explanations.</div>
</body>
</html>
